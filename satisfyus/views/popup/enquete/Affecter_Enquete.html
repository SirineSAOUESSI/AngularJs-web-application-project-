

<div class="modal-body">
<div class="container-fluid">
<div class="row">
<div class="col-md-12">
<div class="card" >
<div class="card-header text-white" style="background: linear-gradient(to right, #6600ff 0%, #cc0066 100%);">
<center><h4 class="card-title" >{{Titre}} </h4></center>
</div>
<div class="card-body">
<div class="row">
<div class="col-md-6"> 
<input type="text" name="id_event" id="id_event" placeholder="index" class="form-control m-input" ng-model="index" disabled ng-hide="true">
<input type="text" name="id_enquete" id="id_enquete" placeholder="instance.id_enquete" class="form-control m-input" ng-model="instance.id_enquete" disabled ng-hide="true">
<input type="text" name="titre" id="titre" placeholder="Titre" class="form-control m-input" ng-model="Titre" disabled ng-hide="true"><br>
<input type="text" placeholder="agentId" ng-model="agentId" id="agentId"  ng-hide="true">
<input type="text" id="agentId2" placeholder="id" ng-model="id" ng-hide="true">                                          
</div>
</div>

<div class="row">

    <div class="col-md-12">
    
    
    <label>Jours {{index}}</label>
    <table class="table table-bordered table-striped">
    <thead>
    <th>Dimanche</th>
    <th>Lundi</th>
    <th>Mardi</th>
    <th>Mercredi</th>
    <th>Jeudi</th>
    <th>Vendredi</th>
    <th>Samedi</th>
    </thead>
    <tbody>
    <tr>
    <td><input type="checkbox" class="jours" name="dimanche" value="0"></td>
    <td><input type="checkbox" class="jours" name="lundi" value="1"></td>
    <td><input type="checkbox" class="jours" name="mardi" value="2"></td>
    <td><input type="checkbox" class="jours" name="mercredi" value="3"></td>
    <td><input type="checkbox" class="jours" name="jeudi" value="4"></td>
    <td><input type="checkbox" class="jours" name="vendredi" value="5"></td>
    <td><input type="checkbox" class="jours" name="samedi" value="6"></td>
    </tr>
    </tbody>
    </table>
    </div>
    <div class="col-md-12">
    <label>Mois</label>
    <table class="table table-bordered table-striped">
    <thead>
    <th>Janvier</th>
    <th>Février</th>
    <th>Mars</th>
    <th>Avril</th>
    <th>Mai</th>
    <th>Juin</th>
    <th>Juillet</th>
    <th>Aout</th>
    <th>Septembre</th>
    <th>Octobre</th>
    <th>Novembre</th>
    <th>Décembre</th>
    </thead>
    <tbody>
    <tr>
    <td><input type="checkbox" class="mois" name="janvier" value="0"></td>
    <td><input type="checkbox" class="mois" name="fevrier" value="1"></td>
    <td><input type="checkbox" class="mois" name="mars" value="2"></td>
    <td><input type="checkbox" class="mois" name="avril" value="3"></td>
    <td><input type="checkbox" class="mois" name="mai" value="4"></td>
    <td><input type="checkbox" class="mois" name="juin" value="5"></td>
    <td><input type="checkbox" class="mois" name="juillet" value="6"></td>
    <td><input type="checkbox" class="mois" name="aout" value="7"></td>
    <td><input type="checkbox" class="mois" name="septembre" value="8"></td>
    <td><input type="checkbox" class="mois" name="octobre" value="9"></td>
    <td><input type="checkbox" class="mois" name="novembre" value="10"></td>
    <td><input type="checkbox" class="mois" name="decembre" value="11"></td>
    </tr>
    </tbody>
    </table>
    </div>
    
    <div class="col-md-6">
    <label class="control-label">Date Debut:</label>  <input type="text" class="form-control" id="datepicker"  readonly="true">  
    
    </div>
    <div class="col-md-6">
        <label class="control-label">Date Fin:</label>  <input type="text" class="form-control" id="datepicker2"  readonly="true">  
        
    </div>
    </br>
 
    </div> 
  <br>  
<div class="row">
<div class="col-md-4">
    
<ui-select ng-model="cli.selected"  theme="bootstrap">
<ui-select-match placeholder="Sélectionnez un agent...">{{$select.selected.Prenom}} {{$select.selected.Nom}}</ui-select-match>
<ui-select-choices repeat="agent in listagent| filter: $select.search">
{{agent.Prenom}}   {{agent.Nom}}
</ui-select-choices>
</ui-select>

<!--<select class="selectpicker select-client"  data-live-search="true" ng-model="client">
        <option ng-repeat="agent in listagent">{{agent.Prenom}}   {{agent.Nom}}</option>
     </select>-->

</div>
<div class="col-md-1">
  <label>H_D</label>    
</div>   
<div class="col-md-3">
  <input class="form-control"   id="m_timepicker_3" placeholder="checkOut" type="text" ng-model="$parent.checkOut"/>
</div>  
<div class="col-md-1">
  <label>H_F</label>    
</div> 
<div class="col-md-3">  
    <input class="form-control" id="m_timepicker_4" placeholder="heure_fin" type="text" class="time2" ng-model="$parent.heure_fin"/>
</div>  
</div>
<br>
<div>
<button type="button" class="btn m-btn--pill m-btn--air m-btn--gradient-from-focus m-btn--gradient-to-danger" ng-click="add_agent()" id="valider">Valider</button>
</div>
<br>
<div>
    <table class="table table-striped- table-bordered table-hover table-checkable" id="m_table_1">
        <thead>
            <tr>
                <th>Agents</th>
                <th>NOM</th>
                <th>Heure_debut</th>
                <th>Heure_fin</th>
             
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="agent in les_agent ">
                <td class="id">{{$index+1}}</td>
                <td class="nom"><button id="m_login_signin_submit" class="btn btn-focus m-btn m-btn--pill m-btn--custom m-btn--air" ng-click="suppAgent(agent.id)" ><i class="m-menu__link-icon flaticon-cancel"></i> {{agent.Nom}}</button> 
                </td>
                <td class="heure_d">{{agent.heure_debut}}</td>
                <td class="heure_f">{{agent.heure_fin}}</td>
             
            </tr>		
        </tbody>
    </table>

</div>

<div class="col-md-12">
    <button class="btn btn-primary" id="savebtn"><span class="glyphicon glyphicon-floppy-disk"></span> Enregistrer</button>
</div>

 
</div>
<div class="col-md-12">
<div id='calendar'></div>
</div>







</div>  
</div>

</div>
</div>

<div class="row">

</div>
<br>
<div class="row">
<div class="col-md-9">
</div>
<div class="col-md-3">
<button type="button" class="btn m-btn--pill m-btn--air btn-outline-metal m-btn m-btn--custom" ng-click="cancel()">Fermer</button>
</div>
</div>
</div>
</div>
<!---------------------------------------------------------------JAVASCRIPT---------------------------------------------------------------------------->
<script>
$(document).ready(function($scope) {
var base_url = window.location.origin;
var host = window.location.host;
var pathparts = location.pathname.split('/') ;
var URL=base_url +'/'+pathparts[1];
$(".jours").click(function(){
$("#datepicker").val('');
$("#datepicker2").val('');
var jourselect=[];
var moisselect=[]
$('.jours').each(function(index,value){
if(this.checked==true){
jourselect.push(this.value);
}
});
getavailabledate(jourselect);

});
$(".mois").click(function(){

$("#datepicker2").val('');
var moisselect=[];
$('.mois').each(function(index,value){
if(this.checked==true){
    moisselect.push(this.value);
}
});
getdate(moisselect);


});
function getavailabledate(jourselect){
var now=new Date();
now.setDate(now.getDate() - 1);
$("#datepicker").datepicker("destroy");
$("#datepicker").datepicker({
prevText: 'Précédent',
nextText: 'Suivant',
currentText: 'Aujourd\'hui',
monthNames: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
monthNamesShort: ['Janv.', 'Févr.', 'Mars', 'Avril', 'Mai', 'Juin', 'Juil.', 'Août', 'Sept.', 'Oct.', 'Nov.', 'Déc.'],
dayNames: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],
dayNamesShort: ['Dim.', 'Lun.', 'Mar.', 'Mer.', 'Jeu.', 'Ven.', 'Sam.'],
dayNamesMin: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
beforeShowDay: function(date){
var day = date.getDay();
if (date<now) 
return [''];
else{
var trouve=false;
for (var i = 0; i < jourselect.length; i++) {
if(jourselect[i]==day) trouve=true;
}
return [trouve];
}
}});
}

function getdate(moisselect){
var now=new Date();
now.setDate(now.getMonth()-1);
$("#datepicker2").datepicker("destroy");
$("#datepicker2").datepicker({
prevText: 'Précédent',
nextText: 'Suivant',
currentText: 'Aujourd\'hui',
monthNames: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
monthNamesShort: ['Janv.', 'Févr.', 'Mars', 'Avril', 'Mai', 'Juin', 'Juil.', 'Août', 'Sept.', 'Oct.', 'Nov.', 'Déc.'],
dayNames: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],
dayNamesShort: ['Dim.', 'Lun.', 'Mar.', 'Mer.', 'Jeu.', 'Ven.', 'Sam.'],
dayNamesMin: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
beforeShowDay: function(date){
var month = date.getMonth();
var day = date.getDay();
if (date<now) 
return [''];
else{
var trouve=false;
for (var i = 0; i < moisselect.length; i++) {
if(moisselect[i]==month) {
    trouve=true;
}
}
return [trouve];
}
}});


}



function Searchin(tbl,x){
var t=false
for (var i = 0; i < tbl.length; i++) {
if(tbl[i].position==x.toString() && tbl[i].value)
t=true;
}
return t;
}

function generate_events(title){
var strdate=$('#datepicker').val();
var strdate2=$('#datepicker2').val();
var array=strdate.split('/');
var startyear=parseInt(array[2]);
var startmonth=parseInt(array[0]);
var startdate=parseInt(array[1]);
startmonth=startmonth-1;
var endmonth=startmonth;
var enddate=startdate;
var endyear=startyear+1;


//intalisation tableau jours et mois
var tbljours=[];
var tblmois=[];

$('.jours').each(function(index,value){
tbljours.push({position:this.value , value:this.checked});
});
$('.mois').each(function(index,value){
tblmois.push({position:this.value , value:this.checked});
});

var event = [];
// creer tableau des event de 1 année 

for (var d = new Date(startyear,startmonth,startdate); d < new Date(endyear,endmonth,enddate); d.setDate(d.getDate() + 1)) {

if(Searchin(tbljours,d.getDay())&&Searchin(tblmois,d.getMonth())){

var m=d.getMonth()+1;
m=m<=9 ? "0"+m.toString():m.toString();
var day=d.getDate();
day=day<=9 ? "0"+day.toString():day.toString();
event.push({title:title ,start:d.getFullYear()+"-"+m+"-"+day});

}
}
return {'event':event,'tblmois':tblmois,'tbljours':tbljours};
}

$('#savebtn').click(function(){
 alert('Enregistrement avec succés');
var id_agent1 = $("#agentId2").val();
var idenquete = $("#id_enquete").val();
var titre = $("#titre").val();



var donnee=generate_events(titre);

$.post(URL+'/serverside/calendar/updateCalendarData.php', {title:titre,id_enquete:idenquete},function(data){
var dt=$.parseJSON(data);

if(dt.response=="ok"){
$('#calendar').fullCalendar('removeEvents');// vider l agenda
$('#calendar').fullCalendar('addEventSource', donnee.event );// mettre ajour l ' agenda par  les nouveau events

var res = "";
$('#m_table_1').find("tbody").find("tr").each(function(){
       var id= $(this).find(".id").text();
	   var nom= $(this).find(".nom").text();
       var heure_d= $(this).find(".heure_d").text();
       var heure_f= $(this).find(".heure_f").text();
	   res+=id+','+nom+','+heure_d+','+heure_f+'/'; 
        
    })

var id_enquete= $("#id_enquete").val();
$.post(URL+'/serverside/calendar/ConsulterEvent.php',{id_enquete:id_enquete},function(data){
data1=$.parseJSON(data);
var id_event=data1[0].id_event;
var Agent=res.split('/');
var id_agent1 = $("#agentId2").val();
var id_agent=id_agent1.split(',');
for(let ji=0;ji<id_agent.length-1;ji++)
{
    /*********Ajouter Notification********/
    var msg="ona était ajouté une nouvelle enquete <<"+titre+">>";
    $.post(URL+'/serverside/notification/Agent/AjouterNotification_Agent.php',{id_agent:id_agent[ji],msg:msg},function(data){
    data=$.parseJSON(data);})
    var id_event=data1[0].id_event;
    /************Ajouter Events************************/
    $.post(URL+'/serverside/calendar/getEvents.php',{id_agent:id_agent[ji],id_event:id_event},function(data){
    data=$.parseJSON(data);

    var Agent_attribut=Agent[ji].split(',');
    var idevent=data1[0].id_event;
    var status="en cour";
    var i=0;
    var test=true;
    var time_debut=Agent_attribut[2];
    var time_fin=Agent_attribut[3];
    var donnee=generate_events(titre);
    /******if events n'existe pas ********************/
    if (data.length==0)
    {
    $.post(URL+'/serverside/calendar/insertAgent.php',{jour:donnee.tbljours,mois:donnee.tblmois ,date:$('#datepicker').val(),date2:$('#datepicker2').val(),id_agent:id_agent[ji],id_event:idevent,status:status,time_debut:time_debut ,time_fin:time_fin },function(data){
   var gt=$.parseJSON(data);})
    }
    /******if events existe********************/
    else
     {
    $.post(URL+'/serverside/calendar/updateAgent.php',{jour:donnee.tbljours,mois:donnee.tblmois ,date:$('#datepicker').val(),date2:$('#datepicker2').val(),id_agent:id_agent[ji],id_event:idevent,status:status,time_debut:time_debut ,time_fin:time_fin },function(data){
    var gt=$.parseJSON(data);})
    }


   
    });
}
});
}
}); 
console.log(donnee.event);
// }

// });


});

$('#calendar').fullCalendar({
defaultView: 'month',
displayEventTime: false,
editable: true,
eventLimit: true

});

// load data config from data base 

function isintervention(tblintervention,value){
let trouve=false;
for (var i = 0; i < tblintervention.length; i++) {
if(tblintervention[i]==value) trouve=true;
}
return trouve;
}

});
</script>
<!---------------------------------------------------------------JAVASCRIPT---------------------------------------------------------------------------->


<script src="assets/demo/default/custom/crud/forms/widgets/bootstrap-timepicker.js" type="text/javascript"></script>
<script src="assets/vendors/base/vendors.bundle.js" type="text/javascript"></script>
<script src='assets/calendar/fullcalendar.min.js'></script>





